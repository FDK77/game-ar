<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>AR Star Collector (Auto-Collect)</title>

  <!-- A-Frame 0.9.2 -->
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <!-- AR.js для GPS-AR -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <!-- aframe-physics-system (если нужно, но здесь физика не обязательна) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.0/dist/aframe-physics-system.min.js"></script>

  <script>
    // Компонент, который автоматически собирает звезду, когда камера близко.
    AFRAME.registerComponent('auto-collect', {
      schema: {
        threshold: { type: 'number', default: 1.5 } // расстояние в метрах, при котором звезда считается собранной
      },
      init: function() {
        // Находим камеру (предполагается, что она имеет компонент gps-camera)
        this.cameraEl = document.querySelector('[gps-camera]');
      },
      tick: function() {
        if (!this.cameraEl) { return; }
        // Получаем мировые позиции звезды и камеры
        const starPos = new THREE.Vector3();
        const camPos = new THREE.Vector3();
        this.el.object3D.getWorldPosition(starPos);
        this.cameraEl.object3D.getWorldPosition(camPos);
        // Вычисляем расстояние
        const distance = starPos.distanceTo(camPos);
        if (distance < this.data.threshold) {
          // Обновляем счёт
          const scoreEl = document.getElementById('scoreText');
          let currentScore = parseInt(scoreEl.innerText.split(':')[1]) || 0;
          currentScore++;
          scoreEl.innerText = 'Score: ' + currentScore;
          // Удаляем звезду
          if(this.el.parentNode) {
            this.el.parentNode.removeChild(this.el);
          }
        }
      }
    });

    // Компонент, который спаунит звёзды вокруг игрока (с GPS-координатами)
    AFRAME.registerComponent('star-spawner', {
      init: function () {
        // Интервал спауна в мс (звёзды появляются чаще)
        this.spawnInterval = 1000;
        // Запускаем спаун звёзд
        this.spawnStar();
        setInterval(() => {
          this.spawnStar();
        }, this.spawnInterval);
      },
      spawnStar: function () {
        const starEl = document.createElement('a-entity');
        // Добавляем компонент auto-collect вместо клика
        starEl.setAttribute('auto-collect', '');
        // Можно использовать 3D модель, если есть. Здесь пример с примитивной сферой:
        starEl.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
        starEl.setAttribute('material', 'color: yellow; emissive: yellow;');
        starEl.setAttribute('animation', 'property: rotation; from: 0 0 0; to: 0 360 0; dur: 4000; loop: true');

        // Генерируем случайное смещение относительно камеры (в метрах)
        const offsetX = (Math.random() - 0.5) * 20; // от -10 до 10
        const offsetZ = (Math.random() - 0.5) * 20;
        // Преобразуем смещение из метров в градусы (приблизительно)
        const latOffset = offsetX / 111320;
        // Предполагаем среднюю широту, например, 55.7558 (Москва)
        const lngOffset = offsetZ / (111320 * Math.cos(55.7558 * Math.PI/180));

        // Получаем базовые координаты из gps-camera
        const gpsCam = document.querySelector('[gps-camera]');
        const camData = gpsCam.getAttribute('gps-camera');
        const baseLat = camData.simulateLatitude || camData.latitude;
        const baseLng = camData.simulateLongitude || camData.longitude;
        const starLat = baseLat + latOffset;
        const starLng = baseLng + lngOffset;

        // Устанавливаем позицию звезды через gps-entity-place
        starEl.setAttribute('gps-entity-place', `latitude: ${starLat}; longitude: ${starLng}`);
        // Добавляем звезду в сцену
        this.el.appendChild(starEl);
      }
    });
  </script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }
    /* Фиксированный интерфейс для счета */
    #scoreText {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: white;
      z-index: 1000;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
<!-- Интерфейсный блок для счёта -->
<div id="scoreText">Score: 0</div>

<!-- Сцена AR с AR.js и gps-camera -->
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" star-spawner>
  <a-assets>
    <a-asset-item id="starModel" src="star.glb"></a-asset-item>
  </a-assets>

  <!-- Камера с gps-camera. На десктопе используется симуляция координат -->
  <a-camera gps-camera="simulateLatitude: 55.7558; simulateLongitude: 37.6173;" rotation-reader></a-camera>
</a-scene>
</body>
</html>
